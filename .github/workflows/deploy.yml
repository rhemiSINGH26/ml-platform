name: CD - Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run smoke tests
      run: |
        python -c "import config.settings; print('Config OK')"
        python -c "from training import train_pipeline; print('Training module OK')"
        python -c "from services.api import main; print('API module OK')"
    
    - name: Build and push Docker images
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        
        # Build images with version tag
        VERSION_TAG=${GITHUB_SHA::8}
        
        docker build -f Dockerfile.api -t $DOCKER_USERNAME/mlops-api:$VERSION_TAG -t $DOCKER_USERNAME/mlops-api:latest .
        docker build -f Dockerfile.ui -t $DOCKER_USERNAME/mlops-ui:$VERSION_TAG -t $DOCKER_USERNAME/mlops-ui:latest .
        docker build -f Dockerfile.agent -t $DOCKER_USERNAME/mlops-agent:$VERSION_TAG -t $DOCKER_USERNAME/mlops-agent:latest .
        
        # Push images
        docker push $DOCKER_USERNAME/mlops-api:$VERSION_TAG
        docker push $DOCKER_USERNAME/mlops-api:latest
        docker push $DOCKER_USERNAME/mlops-ui:$VERSION_TAG
        docker push $DOCKER_USERNAME/mlops-ui:latest
        docker push $DOCKER_USERNAME/mlops-agent:$VERSION_TAG
        docker push $DOCKER_USERNAME/mlops-agent:latest
    
    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID_API: ${{ secrets.RENDER_SERVICE_ID_API }}
        RENDER_SERVICE_ID_UI: ${{ secrets.RENDER_SERVICE_ID_UI }}
        RENDER_SERVICE_ID_AGENT: ${{ secrets.RENDER_SERVICE_ID_AGENT }}
      run: |
        # Trigger Render deployment via API
        curl -X POST \
          "https://api.render.com/v1/services/${RENDER_SERVICE_ID_API}/deploys" \
          -H "Authorization: Bearer ${RENDER_API_KEY}" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": false}'
        
        curl -X POST \
          "https://api.render.com/v1/services/${RENDER_SERVICE_ID_UI}/deploys" \
          -H "Authorization: Bearer ${RENDER_API_KEY}" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": false}'
        
        curl -X POST \
          "https://api.render.com/v1/services/${RENDER_SERVICE_ID_AGENT}/deploys" \
          -H "Authorization: Bearer ${RENDER_API_KEY}" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": false}'
    
    - name: Wait for deployment
      run: |
        echo "Waiting for services to start..."
        sleep 60
    
    - name: Health check
      env:
        API_URL: ${{ secrets.API_URL }}
      run: |
        # Check API health
        curl -f ${API_URL}/health || exit 1
        echo "API is healthy!"
        
        # Check API docs
        curl -f ${API_URL}/docs || exit 1
        echo "API docs accessible!"
    
    - name: Notify deployment
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          Deployment ${{ job.status }}!
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      continue-on-error: true
